<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>pinktrace: pink-simple-strace-freebsd.c</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">pinktrace
   &#160;<span id="projectnumber">Version 0.1.3</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript" src="dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">pink-simple-strace-freebsd.c</div>  </div>
</div>
<div class="contents">
<p>Simple strace like program example written with pinktrace for FreeBSD.</p>
<div class="fragment"><pre class="fragment"><span class="comment">/**</span>
<span class="comment"> * \file</span>
<span class="comment"> *</span>
<span class="comment"> * Example \ref pink-simple-strace-freebsd.c &quot;pink-simple-strace-freebsd.c&quot; .</span>
<span class="comment"> **/</span>
<span class="comment"></span>
<span class="comment">/**</span>
<span class="comment"> * \example pink-simple-strace-freebsd.c</span>
<span class="comment"> *</span>
<span class="comment"> * Simple strace like program example written with pinktrace for FreeBSD.</span>
<span class="comment"> **/</span>

<span class="preprocessor">#include &lt;assert.h&gt;</span>
<span class="preprocessor">#include &lt;err.h&gt;</span>
<span class="preprocessor">#include &lt;errno.h&gt;</span>
<span class="preprocessor">#include &lt;sys/syscall.h&gt;</span>
<span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
<span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<span class="preprocessor">#include &lt;signal.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;unistd.h&gt;</span>
<span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="pink_8h.html" title="A header file including all other header files part of pinktrace.">pinktrace/pink.h</a>&gt;</span>

<span class="preprocessor">#define MAX_STRING_LEN 128</span>
<span class="preprocessor"></span>
<span class="keyword">struct </span>child {
        pid_t pid;
        <a class="code" href="group__g__bitness.html#ga2956d2ca443a21d4a413d825ee664f72">pink_bitness_t</a> bitness;
        <span class="keywordtype">bool</span> insyscall;
        <span class="keywordtype">bool</span> inexecve;
        <span class="keywordtype">bool</span> printret;
};

<span class="comment">/* Utility functions */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span>
print_ret(<span class="keywordtype">long</span> ret)
{
        <span class="keywordflow">if</span> (ret &gt;= 0)
                printf(<span class="stringliteral">&quot;= %ld&quot;</span>, ret);
        <span class="keywordflow">else</span>
                printf(<span class="stringliteral">&quot;= %ld (%s)&quot;</span>, ret, strerror(-ret));
}

<span class="keyword">static</span> <span class="keywordtype">void</span>
print_open_flags(<span class="keywordtype">long</span> flags)
{
        <span class="keywordtype">long</span> aflags;
        <span class="keywordtype">bool</span> found;

        found = <span class="keyword">true</span>;

        <span class="comment">/* Check out access flags */</span>
        aflags = flags &amp; 3;
        <span class="keywordflow">switch</span> (aflags) {
        <span class="keywordflow">case</span> O_RDONLY:
                printf(<span class="stringliteral">&quot;O_RDONLY&quot;</span>);
                <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> O_WRONLY:
                printf(<span class="stringliteral">&quot;O_WRONLY&quot;</span>);
                <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> O_RDWR:
                printf(<span class="stringliteral">&quot;O_RDWR&quot;</span>);
                <span class="keywordflow">break</span>;
        <span class="keywordflow">default</span>:
                <span class="comment">/* Nothing found */</span>
                found = <span class="keyword">false</span>;
        }

        <span class="keywordflow">if</span> (flags &amp; O_CREAT) {
                printf(<span class="stringliteral">&quot;%s | O_CREAT&quot;</span>, found ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;0&quot;</span>);
                found = <span class="keyword">true</span>;
        }

        <span class="keywordflow">if</span> (!found)
                printf(<span class="stringliteral">&quot;%#x&quot;</span>, (<span class="keywordtype">unsigned</span>)flags);
}

<span class="comment">/* A very basic decoder for open(2) system call. */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span>
decode_open(pid_t pid, <a class="code" href="group__g__bitness.html#ga2956d2ca443a21d4a413d825ee664f72">pink_bitness_t</a> bitness)
{
        <span class="keywordtype">long</span> flags;
        <span class="keywordtype">char</span> buf[MAX_STRING_LEN];

        <span class="keywordflow">if</span> (!<a name="a0"></a><a class="code" href="group__g__decode.html#ga8d854a8f7cd3ff8547d1ade03d2a781c">pink_decode_string</a>(pid, bitness, 0, buf, MAX_STRING_LEN)) {
                perror(<span class="stringliteral">&quot;pink_decode_string&quot;</span>);
                <span class="keywordflow">return</span>;
        }
        <span class="keywordflow">if</span> (!<a name="a1"></a><a class="code" href="group__g__util.html#ga863ef49cd1d43a27f54e6459eaa13503">pink_util_get_arg</a>(pid, bitness, 1, &amp;flags)) {
                perror(<span class="stringliteral">&quot;pink_util_get_arg&quot;</span>);
                <span class="keywordflow">return</span>;
        }

        printf(<span class="stringliteral">&quot;open(\&quot;%s\&quot;, &quot;</span>, buf);
        print_open_flags(flags);
        putchar(<span class="charliteral">&#39;)&#39;</span>);
}

<span class="comment">/* A very basic decoder for execve(2) system call. */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span>
decode_execve(pid_t pid, <a class="code" href="group__g__bitness.html#ga2956d2ca443a21d4a413d825ee664f72">pink_bitness_t</a> bitness)
{
        <span class="keywordtype">bool</span> nil;
        <span class="keywordtype">unsigned</span> i;
        <span class="keywordtype">long</span> arg;
        <span class="keywordtype">char</span> buf[MAX_STRING_LEN];
        <span class="keyword">const</span> <span class="keywordtype">char</span> *sep;

        <span class="keywordflow">if</span> (!<a class="code" href="group__g__decode.html#ga8d854a8f7cd3ff8547d1ade03d2a781c">pink_decode_string</a>(pid, bitness, 0, buf, MAX_STRING_LEN)) {
                perror(<span class="stringliteral">&quot;pink_decode_string&quot;</span>);
                <span class="keywordflow">return</span>;
        }
        <span class="keywordflow">if</span> (!<a class="code" href="group__g__util.html#ga863ef49cd1d43a27f54e6459eaa13503">pink_util_get_arg</a>(pid, bitness, 1, &amp;arg)) {
                perror(<span class="stringliteral">&quot;pink_util_get_arg&quot;</span>);
                <span class="keywordflow">return</span>;
        }

        printf(<span class="stringliteral">&quot;execve(\&quot;%s\&quot;, [&quot;</span>, buf);

        <span class="keywordflow">for</span> (i = 0, nil = <span class="keyword">false</span>, sep = <span class="stringliteral">&quot;&quot;</span>;;sep = <span class="stringliteral">&quot;, &quot;</span>) {
                <span class="keywordflow">if</span> (!<a name="a2"></a><a class="code" href="group__g__decode.html#ga2434e8f6294973b8b44b6b0962867784">pink_decode_string_array_member</a>(pid, bitness, arg, ++i, buf, MAX_STRING_LEN, &amp;nil)) {
                        perror(<span class="stringliteral">&quot;pink_decode_string_array_member&quot;</span>);
                        <span class="keywordflow">return</span>;
                }

                printf(<span class="stringliteral">&quot;%s\&quot;%s\&quot;&quot;</span>, sep, buf);

                <span class="keywordflow">if</span> (nil) {
                        printf(<span class="stringliteral">&quot;], envp[])&quot;</span>);
                        <span class="keywordflow">break</span>;
                }
        }
}

<span class="comment">/* A very basic decoder for bind() and connect() calls */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span>
decode_socketcall(pid_t pid, <a class="code" href="group__g__bitness.html#ga2956d2ca443a21d4a413d825ee664f72">pink_bitness_t</a> bitness, <span class="keyword">const</span> <span class="keywordtype">char</span> *scname)
{
        <span class="keywordtype">long</span> fd;
        <span class="keywordtype">char</span> ip[100];
        <a name="_a3"></a><a class="code" href="structpink__socket__address__t.html" title="Structure which defines a decoded socket address.">pink_socket_address_t</a> addr;

        <span class="keywordflow">if</span> (!<a name="a4"></a><a class="code" href="group__g__decode.html#gaa7468654fd8c80d0bd02bedd70a35384">pink_decode_socket_address</a>(pid, bitness, 1, &amp;fd, &amp;addr)) {
                perror(<span class="stringliteral">&quot;pink_decode_socket_address&quot;</span>);
                <span class="keywordflow">return</span>;
        }

        printf(<span class="stringliteral">&quot;%s(%ld, &quot;</span>, scname, fd);

        <span class="keywordflow">switch</span> (addr.<a name="a5"></a><a class="code" href="structpink__socket__address__t.html#aff0a85d871e2513fb9c18b76fc2a7175">family</a>) {
        <span class="keywordflow">case</span> -1: <span class="comment">/* NULL */</span>
                printf(<span class="stringliteral">&quot;NULL&quot;</span>);
                <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> AF_UNIX:
                printf(<span class="stringliteral">&quot;{sa_family=AF_UNIX, path=\&quot;%s\&quot;}&quot;</span>, addr.<a name="a6"></a><a class="code" href="structpink__socket__address__t.html#a2a7cc648eff334bc90fcefd09531176d">u</a>.<a name="a7"></a><a class="code" href="structpink__socket__address__t.html#a697416ca359d7806b9d2f0a9c6f9824c">sa_un</a>.sun_path);
                <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> AF_INET:
                inet_ntop(AF_INET, &amp;addr.<a class="code" href="structpink__socket__address__t.html#a2a7cc648eff334bc90fcefd09531176d">u</a>.<a name="a8"></a><a class="code" href="structpink__socket__address__t.html#a40ffe6618e6a59301a53be98e9d99e77">sa_in</a>.sin_addr, ip, <span class="keyword">sizeof</span>(ip));
                printf(<span class="stringliteral">&quot;{sa_family=AF_INET, sin_port=htons(%d), sin_addr=inet_addr(\&quot;%s\&quot;)}&quot;</span>,
                                ntohs(addr.<a class="code" href="structpink__socket__address__t.html#a2a7cc648eff334bc90fcefd09531176d">u</a>.<a class="code" href="structpink__socket__address__t.html#a40ffe6618e6a59301a53be98e9d99e77">sa_in</a>.sin_port), ip);
                <span class="keywordflow">break</span>;
<span class="preprocessor">#if PINKTRACE_HAVE_IPV6</span>
<span class="preprocessor"></span>        <span class="keywordflow">case</span> AF_INET6:
                inet_ntop(AF_INET6, &amp;addr.<a class="code" href="structpink__socket__address__t.html#a2a7cc648eff334bc90fcefd09531176d">u</a>.<a name="a9"></a><a class="code" href="structpink__socket__address__t.html#ad37c6826fb69d601c1c2778264e6bd51">sa6</a>.sin6_addr, ip, <span class="keyword">sizeof</span>(ip));
                printf(<span class="stringliteral">&quot;{sa_family=AF_INET6, sin_port=htons(%d), sin6_addr=inet_addr(\&quot;%s\&quot;)}&quot;</span>,
                                ntohs(addr.<a class="code" href="structpink__socket__address__t.html#a2a7cc648eff334bc90fcefd09531176d">u</a>.<a class="code" href="structpink__socket__address__t.html#ad37c6826fb69d601c1c2778264e6bd51">sa6</a>.sin6_port), ip);
                <span class="keywordflow">break</span>;
<span class="preprocessor">#endif </span><span class="comment">/* PINKTRACE_HAVE_IPV6 */</span>
        <span class="keywordflow">default</span>: <span class="comment">/* Unknown family */</span>
                printf(<span class="stringliteral">&quot;{sa_family=???}&quot;</span>);
                <span class="keywordflow">break</span>;
        }

        printf(<span class="stringliteral">&quot;, %u)&quot;</span>, addr.<a name="a10"></a><a class="code" href="structpink__socket__address__t.html#a856b7e682cf840f44fa930734300a271">length</a>);
}

<span class="keyword">static</span> <span class="keywordtype">void</span>
handle_sigtrap(<span class="keyword">struct</span> child *son)
{
        <span class="keywordtype">long</span> scno, ret;
        <span class="keyword">const</span> <span class="keywordtype">char</span> *scname;

        <span class="comment">/* We get this event twice, one at entering a</span>
<span class="comment">         * system call and one at exiting a system</span>
<span class="comment">         * call. */</span>
        <span class="keywordflow">if</span> (son-&gt;insyscall) {
                <span class="keywordflow">if</span> (!<a name="a11"></a><a class="code" href="group__g__util.html#ga699a827f765368f0ce0adc265d2a1b9d">pink_util_get_return</a>(son-&gt;pid, &amp;ret))
                        err(1, <span class="stringliteral">&quot;pink_util_get_return&quot;</span>);
                <span class="keywordflow">if</span> (son-&gt;inexecve) {
                        son-&gt;inexecve = <span class="keyword">false</span>;
                        <span class="keywordflow">if</span> (ret == 0) { <span class="comment">/* execve was successful */</span>
                                <span class="comment">/* Update bitness */</span>
                                son-&gt;bitness = <a name="a12"></a><a class="code" href="group__g__bitness.html#ga407db762c488f6f83b49f15754486202">pink_bitness_get</a>(son-&gt;pid);
                                <span class="keywordflow">if</span> (son-&gt;bitness == <a name="a13"></a><a class="code" href="group__g__bitness.html#gga2956d2ca443a21d4a413d825ee664f72a00a0211c388c81241e8d4a182a05ee23">PINK_BITNESS_UNKNOWN</a>)
                                        err(1, <span class="stringliteral">&quot;pink_bitness_get&quot;</span>);
                                printf(<span class="stringliteral">&quot; = 0 (Updating the bitness of child %i to %s mode)\n&quot;</span>,
                                        son-&gt;pid, <a name="a14"></a><a class="code" href="group__g__bitness.html#ga632430f0e114b1188927b788ba692c95">pink_bitness_name</a>(son-&gt;bitness));
                                son-&gt;printret = <span class="keyword">false</span>;
                                <span class="keywordflow">return</span>;
                        }
                }
                son-&gt;insyscall = <span class="keyword">false</span>;
                <span class="keywordflow">if</span> (!son-&gt;printret) {
                        son-&gt;printret = <span class="keyword">true</span>;
                        <span class="keywordflow">return</span>;
                }
                <span class="comment">/* Exiting the system call, print the</span>
<span class="comment">                 * return value. */</span>
                putchar(<span class="charliteral">&#39; &#39;</span>);
                print_ret(ret);
                putchar(<span class="charliteral">&#39;\n&#39;</span>);
        }
        <span class="keywordflow">else</span> {
                son-&gt;insyscall = <span class="keyword">true</span>;
                <span class="comment">/* Get the system call number and call</span>
<span class="comment">                 * the appropriate decoder. */</span>
                <span class="keywordflow">if</span> (!<a name="a15"></a><a class="code" href="group__g__util.html#ga9a402dd96c4da01544f95e34cfc46967">pink_util_get_syscall</a>(son-&gt;pid, son-&gt;bitness, &amp;scno))
                        err(1, <span class="stringliteral">&quot;pink_util_get_syscall&quot;</span>);
                scname = <a name="a16"></a><a class="code" href="group__g__name.html#ga5bb647c79e307a41a406b552b222e5ae">pink_name_syscall</a>(scno, son-&gt;bitness);
                assert(scname != NULL);

                <span class="keywordflow">if</span> (!strcmp(scname, <span class="stringliteral">&quot;execve&quot;</span>))
                        son-&gt;inexecve = <span class="keyword">true</span>;

                <span class="keywordflow">if</span> (!strcmp(scname, <span class="stringliteral">&quot;open&quot;</span>))
                        decode_open(son-&gt;pid, son-&gt;bitness);
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(scname, <span class="stringliteral">&quot;execve&quot;</span>))
                        decode_execve(son-&gt;pid, son-&gt;bitness);
                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(scname, <span class="stringliteral">&quot;bind&quot;</span>) || !strcmp(scname, <span class="stringliteral">&quot;connect&quot;</span>))
                        decode_socketcall(son-&gt;pid, son-&gt;bitness, scname);
                <span class="keywordflow">else</span>
                        printf(<span class="stringliteral">&quot;%s()&quot;</span>, scname);
        }
}

<span class="keywordtype">int</span>
main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
{
        <span class="keywordtype">int</span> sig, status, exit_code;
        <span class="keyword">struct </span>child son;

        <span class="comment">/* Parse arguments */</span>
        <span class="keywordflow">if</span> (argc &lt; 2) {
                fprintf(stderr, <span class="stringliteral">&quot;Usage: %s program [argument...]\n&quot;</span>, argv[0]);
                <span class="keywordflow">return</span> EXIT_FAILURE;
        }

        <span class="comment">/* Fork */</span>
        <span class="keywordflow">if</span> ((son.pid = fork()) &lt; 0) {
                perror(<span class="stringliteral">&quot;fork&quot;</span>);
                <span class="keywordflow">return</span> EXIT_FAILURE;
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!son.pid) { <span class="comment">/* child */</span>
                <span class="comment">/* Set up for tracing */</span>
                <span class="keywordflow">if</span> (!<a name="a17"></a><a class="code" href="group__g__trace.html#ga29ca39b6da86df95843bb082dfadc8c4">pink_trace_me</a>()) {
                        perror(<span class="stringliteral">&quot;pink_trace_me&quot;</span>);
                        _exit(EXIT_FAILURE);
                }
                <span class="comment">/* Stop and let the parent continue the execution. */</span>
                kill(getpid(), SIGSTOP);

                ++argv;
                execvp(argv[0], argv);
                perror(<span class="stringliteral">&quot;execvp&quot;</span>);
                _exit(-1);
        }
        <span class="keywordflow">else</span> {
                waitpid(son.pid, &amp;status, 0);
                assert(WIFSTOPPED(status));
                assert(WSTOPSIG(status) == SIGSTOP);

                <span class="comment">/* Figure out the bitness of the traced child. */</span>
                son.bitness = <a class="code" href="group__g__bitness.html#ga407db762c488f6f83b49f15754486202">pink_bitness_get</a>(son.pid);
                <span class="keywordflow">if</span> (son.bitness == <a class="code" href="group__g__bitness.html#gga2956d2ca443a21d4a413d825ee664f72a00a0211c388c81241e8d4a182a05ee23">PINK_BITNESS_UNKNOWN</a>)
                        err(1, <span class="stringliteral">&quot;pink_bitness_get&quot;</span>);
                printf(<span class="stringliteral">&quot;Child %i runs in %s mode\n&quot;</span>, son.pid, <a class="code" href="group__g__bitness.html#ga632430f0e114b1188927b788ba692c95">pink_bitness_name</a>(son.bitness));

                son.inexecve = son.insyscall = <span class="keyword">false</span>;
                son.printret = <span class="keyword">true</span>;
                sig = exit_code = 0;
                <span class="keywordflow">for</span> (;;) {
                        <span class="comment">/* At this point the traced child is stopped and needs</span>
<span class="comment">                         * to be resumed.</span>
<span class="comment">                         */</span>
                        <span class="keywordflow">if</span> (!<a name="a18"></a><a class="code" href="group__g__trace.html#gaa64d408c195b70a0d7ab9676405101f0">pink_trace_syscall</a>(son.pid, sig)) {
                                perror(<span class="stringliteral">&quot;pink_trace_syscall&quot;</span>);
                                <span class="keywordflow">return</span> (errno == ESRCH) ? 0 : 1;
                        }
                        sig = 0;

                        <span class="comment">/* Wait for the child */</span>
                        <span class="keywordflow">if</span> ((son.pid = waitpid(son.pid, &amp;status, 0)) &lt; 0) {
                                perror(<span class="stringliteral">&quot;waitpid&quot;</span>);
                                <span class="keywordflow">return</span> (errno == ECHILD) ? 0 : 1;
                        }

                        <span class="comment">/* Check the event */</span>
                        <span class="keywordflow">if</span> (WIFSTOPPED(status)) {
                                <span class="keywordflow">if</span> (WSTOPSIG(status) == SIGTRAP)
                                        handle_sigtrap(&amp;son);
                                <span class="keywordflow">else</span> {
                                        <span class="comment">/* Child received a genuine signal.</span>
<span class="comment">                                         * Send it to the child. */</span>
                                        sig = WSTOPSIG(status);
                                }
                        }
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WIFEXITED(status)) {
                                exit_code = WEXITSTATUS(status);
                                printf(<span class="stringliteral">&quot;Child %i exited normally with return code %d\n&quot;</span>,
                                                son.pid, exit_code);
                                <span class="keywordflow">break</span>;
                        }
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WIFSIGNALED(status)) {
                                exit_code = 128 + WTERMSIG(status);
                                printf(<span class="stringliteral">&quot;Child %i exited with signal %d\n&quot;</span>,
                                                son.pid, WTERMSIG(status));
                                <span class="keywordflow">break</span>;
                        }
                }

                <span class="keywordflow">return</span> exit_code;
        }
}
</pre></div> </div>
</div>


<hr class="footer"/><address class="footer"><small>
Generated on Sat Oct 15 2011 01:54:40 for pinktrace by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
